<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>PC Configurator Ultimate</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',      /* Slate 900 */
                            card: '#1e293b',    /* Slate 800 */
                            input: '#334155',   /* Slate 700 */
                            border: '#475569',  /* Slate 600 */
                        },
                        brand: {
                            500: '#06b6d4',     /* Cyan 500 */
                            600: '#0891b2',     /* Cyan 600 */
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 140px; /* Space for bottom bar */
        }

        /* Input styling adjustments */
        input {
            color-scheme: dark; 
        }
        
        /* Accordion Animations */
        .accordion-content {
            transition: all 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .accordion-content.open {
            max-height: 2000px;
            opacity: 1;
        }
        .chevron {
            transition: transform 0.3s;
        }
        .accordion-btn[aria-expanded="true"] .chevron {
            transform: rotate(180deg);
        }
        .accordion-btn[aria-expanded="true"] {
            border-bottom-color: #334155; 
        }

        /* Glassmorphism utils */
        .glass {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body class="antialiased selection:bg-brand-500 selection:text-white">

    <!-- Header -->
    <header class="glass fixed top-0 left-0 right-0 z-40 pt-safe-top">
        <div class="max-w-3xl mx-auto px-5 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-brand-600 to-blue-600 flex items-center justify-center shadow-lg shadow-brand-500/20">
                    <i class="ph-bold ph-cpu text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight tracking-tight">PC Configurator</h1>
                    <p class="text-xs text-slate-400 font-medium">Build & Price</p>
                </div>
            </div>
            <button id="reset-app-btn" class="w-10 h-10 rounded-full bg-dark-card hover:bg-dark-input flex items-center justify-center text-slate-400 hover:text-white transition border border-dark-border">
                <i class="ph-bold ph-arrow-counter-clockwise"></i>
            </button>
        </div>
    </header>

    <!-- Spacer for fixed header -->
    <div class="h-24"></div>

    <!-- Main Content -->
    <main class="px-4 max-w-3xl mx-auto space-y-5">

        <!-- Core Components Section -->
        <section class="bg-dark-card rounded-2xl border border-dark-border overflow-hidden shadow-xl shadow-black/20">
            <button class="accordion-btn w-full p-5 flex justify-between items-center bg-dark-card active:bg-dark-input transition-colors group" aria-expanded="true" onclick="toggleAccordion('core-section')">
                <div class="flex items-center gap-3">
                    <i class="ph-fill ph-circuitry text-brand-500 text-xl"></i>
                    <span class="font-semibold text-slate-200 text-lg">Core Components</span>
                </div>
                <div class="w-8 h-8 rounded-full bg-dark-bg flex items-center justify-center group-hover:bg-dark-input transition">
                    <i class="ph-bold ph-caret-down text-slate-400 chevron"></i>
                </div>
            </button>
            <div id="core-section" class="accordion-content open border-t border-dark-border bg-dark-bg/30">
                <div id="core-inputs-container" class="p-5 space-y-5">
                    <!-- JS Injects Inputs Here -->
                </div>
            </div>
        </section>

        <!-- Multi-Item Section -->
        <section class="bg-dark-card rounded-2xl border border-dark-border overflow-hidden shadow-xl shadow-black/20">
            <button class="accordion-btn w-full p-5 flex justify-between items-center bg-dark-card active:bg-dark-input transition-colors group" aria-expanded="true" onclick="toggleAccordion('multi-section')">
                <div class="flex items-center gap-3">
                    <i class="ph-fill ph-stack text-purple-500 text-xl"></i>
                    <span class="font-semibold text-slate-200 text-lg">Expansion & Storage</span>
                </div>
                <div class="w-8 h-8 rounded-full bg-dark-bg flex items-center justify-center group-hover:bg-dark-input transition">
                    <i class="ph-bold ph-caret-down text-slate-400 chevron"></i>
                </div>
            </button>
            <div id="multi-section" class="accordion-content open border-t border-dark-border bg-dark-bg/30">
                <div class="p-5 space-y-8">
                    
                    <!-- GPU Group -->
                    <div class="space-y-3">
                        <div class="flex justify-between items-end">
                            <label class="text-sm font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                                <i class="ph-bold ph-graphics-card"></i> GPU
                            </label>
                            <button onclick="addMultiItem('gpu')" class="text-xs bg-brand-600/20 text-brand-500 hover:bg-brand-600/30 px-3 py-1.5 rounded-full font-semibold transition flex items-center gap-1">
                                <i class="ph-bold ph-plus"></i> Add
                            </button>
                        </div>
                        <div id="gpu-list" class="space-y-3"></div>
                    </div>

                    <!-- RAM Group -->
                    <div class="space-y-3">
                        <div class="flex justify-between items-end">
                            <label class="text-sm font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                                <i class="ph-bold ph-memory"></i> RAM
                            </label>
                            <button onclick="addMultiItem('ram')" class="text-xs bg-brand-600/20 text-brand-500 hover:bg-brand-600/30 px-3 py-1.5 rounded-full font-semibold transition flex items-center gap-1">
                                <i class="ph-bold ph-plus"></i> Add
                            </button>
                        </div>
                        <div id="ram-list" class="space-y-3"></div>
                    </div>

                    <!-- Storage Group -->
                    <div class="space-y-3">
                        <div class="flex justify-between items-end">
                            <label class="text-sm font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                                <i class="ph-bold ph-hard-drive"></i> Storage
                            </label>
                            <button onclick="addMultiItem('ssd')" class="text-xs bg-brand-600/20 text-brand-500 hover:bg-brand-600/30 px-3 py-1.5 rounded-full font-semibold transition flex items-center gap-1">
                                <i class="ph-bold ph-plus"></i> Add
                            </button>
                        </div>
                        <div id="ssd-list" class="space-y-3"></div>
                    </div>

                </div>
            </div>
        </section>

        <!-- Optional & Extras -->
        <section class="bg-dark-card rounded-2xl border border-dark-border overflow-hidden shadow-xl shadow-black/20">
             <button class="accordion-btn w-full p-5 flex justify-between items-center bg-dark-card active:bg-dark-input transition-colors group" aria-expanded="false" onclick="toggleAccordion('extras-section')">
                <div class="flex items-center gap-3">
                    <i class="ph-fill ph-sliders-horizontal text-emerald-500 text-xl"></i>
                    <span class="font-semibold text-slate-200 text-lg">Cooling & Extras</span>
                </div>
                <div class="w-8 h-8 rounded-full bg-dark-bg flex items-center justify-center group-hover:bg-dark-input transition">
                    <i class="ph-bold ph-caret-down text-slate-400 chevron"></i>
                </div>
            </button>
            <div id="extras-section" class="accordion-content border-t border-dark-border bg-dark-bg/30">
                <div class="p-5 space-y-6">
                    
                    <!-- Single Optionals -->
                    <div id="optional-inputs-container" class="space-y-4"></div>
                    
                    <hr class="border-dark-border opacity-50">

                    <!-- Multi Extras -->
                    <div class="space-y-6">
                        <!-- Fans -->
                        <div class="space-y-2">
                             <div class="flex justify-between items-center">
                                <label class="text-xs font-bold text-slate-500 uppercase">Fans</label>
                                <button onclick="addMultiItem('fans')" class="text-brand-500 hover:text-brand-400 text-xl"><i class="ph-bold ph-plus-circle"></i></button>
                            </div>
                            <div id="fans-list" class="space-y-3"></div>
                        </div>
                        <!-- Cables -->
                        <div class="space-y-2">
                             <div class="flex justify-between items-center">
                                <label class="text-xs font-bold text-slate-500 uppercase">Cables</label>
                                <button onclick="addMultiItem('cables')" class="text-brand-500 hover:text-brand-400 text-xl"><i class="ph-bold ph-plus-circle"></i></button>
                            </div>
                            <div id="cables-list" class="space-y-3"></div>
                        </div>
                         <!-- Other -->
                         <div class="space-y-2">
                            <div class="flex justify-between items-center">
                               <label class="text-xs font-bold text-slate-500 uppercase">Other</label>
                               <button onclick="addMultiItem('other')" class="text-brand-500 hover:text-brand-400 text-xl"><i class="ph-bold ph-plus-circle"></i></button>
                           </div>
                           <div id="other-list" class="space-y-3"></div>
                       </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Bottom Action Bar -->
    <div class="glass fixed bottom-0 left-0 right-0 p-4 pb-safe-bottom z-50">
        <div class="max-w-3xl mx-auto flex gap-4 items-center justify-between">
            <div class="flex flex-col">
                <span class="text-[10px] uppercase font-bold text-slate-500 tracking-wider">Estimated Total</span>
                <span id="bar-total" class="text-2xl font-bold text-brand-500 font-mono tracking-tight">$0.00</span>
            </div>
            <button onclick="openSummary()" class="flex-1 bg-white text-slate-900 hover:bg-slate-200 active:scale-95 transition rounded-xl py-3 px-6 font-bold shadow-lg shadow-white/5 flex items-center justify-center gap-2">
                <span>Review</span>
                <i class="ph-bold ph-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div id="summary-modal" class="fixed inset-0 z-[60] hidden transition-all duration-300">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity opacity-0" id="modal-backdrop" onclick="closeSummary()"></div>
        
        <!-- Panel -->
        <div class="absolute bottom-0 left-0 right-0 bg-dark-card rounded-t-3xl max-h-[90vh] overflow-y-auto transform translate-y-full transition-transform duration-300 ease-out border-t border-dark-border shadow-2xl shadow-black" id="modal-panel">
            
            <!-- Handle for dragging feel -->
            <div class="sticky top-0 bg-dark-card z-10 pt-4 pb-2 flex justify-center" onclick="closeSummary()">
                <div class="w-12 h-1.5 rounded-full bg-slate-600"></div>
            </div>

            <div class="p-6 space-y-8 pb-10">
                <div class="flex justify-between items-start">
                    <h2 class="text-2xl font-bold text-white">Build Summary</h2>
                    <button onclick="closeSummary()" class="w-8 h-8 rounded-full bg-dark-input flex items-center justify-center text-slate-400">
                        <i class="ph-bold ph-x"></i>
                    </button>
                </div>

                <!-- Financial Card -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-5 border border-dark-border relative overflow-hidden">
                    <!-- Decor -->
                    <div class="absolute top-0 right-0 w-32 h-32 bg-brand-500/10 rounded-full blur-3xl -mr-10 -mt-10"></div>
                    
                    <div class="space-y-3 relative z-10">
                        <!-- Base Cost (No Profit) -->
                        <div class="flex justify-between text-slate-400 text-sm">
                            <span>Base Cost (Parts Only)</span>
                            <span id="modal-subtotal" class="font-mono text-white">$0.00</span>
                        </div>

                        <!-- Profit Controls -->
                        <div class="flex justify-between items-center text-sm py-2">
                            <span class="text-slate-400">Profit</span>
                            <div class="flex items-center gap-2">
                                <!-- Mode Toggle -->
                                <div class="flex bg-dark-bg rounded-lg border border-dark-border p-1">
                                    <button id="profit-mode-percent" class="px-3 py-1 rounded-md text-xs font-bold transition bg-brand-600 text-white shadow-sm" onclick="setProfitMode('percent')">%</button>
                                    <button id="profit-mode-fixed" class="px-3 py-1 rounded-md text-xs font-bold transition text-slate-400 hover:text-white" onclick="setProfitMode('fixed')">$</button>
                                </div>
                                <!-- Input -->
                                <div class="flex items-center gap-1 bg-dark-bg rounded-lg border border-dark-border px-3 py-1 w-24">
                                    <input type="number" id="profit-input" value="15" class="w-full bg-transparent text-right outline-none text-brand-500 font-bold" oninput="handleProfitInput(event)">
                                </div>
                            </div>
                        </div>

                        <!-- Calculated Profit Display -->
                        <div class="flex justify-between text-emerald-500 text-sm">
                            <span>Calculated Profit</span>
                            <span id="modal-profit" class="font-mono font-medium">+$0.00</span>
                        </div>

                        <div class="h-px bg-dark-border/50 my-2"></div>
                        
                        <!-- Final Total -->
                        <div class="flex justify-between items-end">
                            <span class="font-bold text-slate-200">Grand Total</span>
                            <span id="modal-total" class="font-bold text-3xl text-brand-500 tracking-tight font-mono">$0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Save/Load Actions -->
                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Configuration Management</h3>
                    
                    <div class="bg-dark-bg p-1 rounded-xl border border-dark-border flex">
                        <input type="text" id="build-name" placeholder="Build Name..." class="bg-transparent flex-1 p-3 outline-none text-white placeholder-slate-600">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="handleSave()" class="bg-brand-600 hover:bg-brand-500 text-white p-3.5 rounded-xl font-semibold shadow-lg shadow-brand-500/20 active:scale-95 transition">
                            Save Build
                        </button>
                        <button onclick="handleDelete()" class="bg-dark-input hover:bg-red-500/20 hover:text-red-400 text-slate-300 border border-dark-border hover:border-red-500/50 p-3.5 rounded-xl font-semibold active:scale-95 transition">
                            Delete
                        </button>
                    </div>

                    <p id="save-msg" class="text-center text-xs h-4"></p>

                    <div class="relative">
                        <select id="saved-builds-select" class="w-full appearance-none bg-dark-input text-white border border-dark-border rounded-xl p-3.5 outline-none focus:border-brand-500 transition" onchange="handleLoad()">
                            <option value="">Load a saved build...</option>
                        </select>
                        <div class="absolute right-4 top-4 text-slate-400 pointer-events-none">
                            <i class="ph-bold ph-caret-down"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DATALISTS FOR AUTOCOMPLETE -->
    <datalist id="cpu-options"></datalist>
    <datalist id="gpu-options"></datalist>
    <datalist id="ram-options"></datalist>
    <datalist id="ssd-options"></datalist>

    <!-- JS Logic -->
    <script>
        // --- EMBEDDED CSV DATA ---
        const HARDWARE_DATA_CSV = `
Type,Name,Price
CPU,AMD Ryzen 9 9950X,649
CPU,AMD Ryzen 9 9900X,499
CPU,AMD Ryzen 7 9700X,359
CPU,AMD Ryzen 5 9600X,279
CPU,AMD Ryzen 7 9800X3D,479
CPU,AMD Ryzen 9 7950X3D,599
CPU,AMD Ryzen 9 7950X,549
CPU,AMD Ryzen 9 7900X3D,449
CPU,AMD Ryzen 9 7900X,399
CPU,AMD Ryzen 7 7800X3D,369
CPU,AMD Ryzen 7 7700X,299
CPU,AMD Ryzen 5 7600X,229
CPU,AMD Ryzen 5 7600,199
CPU,Intel Core Ultra 9 285K,589
CPU,Intel Core Ultra 7 265K,394
CPU,Intel Core Ultra 5 245K,309
CPU,Intel Core i9-14900K,549
CPU,Intel Core i7-14700K,399
CPU,Intel Core i5-14600K,299
CPU,Intel Core i9-13900K,499
CPU,Intel Core i7-13700K,359
CPU,Intel Core i5-13600K,269

GPU,Nvidia GeForce RTX 5090,1999
GPU,Nvidia GeForce RTX 5080,999
GPU,Nvidia GeForce RTX 5070 Ti,749
GPU,Nvidia GeForce RTX 5070,549
GPU,Nvidia GeForce RTX 5060 Ti,429
GPU,Nvidia GeForce RTX 5060,299
GPU,Nvidia GeForce RTX 5050,249
GPU,Nvidia GeForce RTX 4090,1599
GPU,Nvidia GeForce RTX 4080 Super,999
GPU,Nvidia GeForce RTX 4080,1199
GPU,Nvidia GeForce RTX 4070 Ti Super,799
GPU,Nvidia GeForce RTX 4070 Super,599
GPU,Nvidia GeForce RTX 4070,549
GPU,Nvidia GeForce RTX 4060 Ti,399
GPU,Nvidia GeForce RTX 4060,299
GPU,AMD Radeon RX 9070 XT,629
GPU,AMD Radeon RX 9070,549
GPU,AMD Radeon RX 9060 XT,349
GPU,AMD Radeon RX 7900 XTX,899
GPU,AMD Radeon RX 7900 XT,699
GPU,AMD Radeon RX 7900 GRE,549
GPU,AMD Radeon RX 7800 XT,499
GPU,AMD Radeon RX 7700 XT,449
GPU,AMD Radeon RX 7600 XT,329
GPU,AMD Radeon RX 7600,269
GPU,Intel Arc B580,249
GPU,Intel Arc B570,229
GPU,Intel Arc A770,299

RAM,DDR4 16GB (2x8GB) 3200MHz,35
RAM,DDR4 32GB (2x16GB) 3200MHz,60
RAM,DDR4 64GB (2x32GB) 3200MHz,110
RAM,DDR4 128GB (4x32GB) 3200MHz,250
RAM,DDR5 16GB (2x8GB) 5600MHz,55
RAM,DDR5 32GB (2x16GB) 6000MHz,95
RAM,DDR5 64GB (2x32GB) 6000MHz,185
RAM,DDR5 128GB (4x32GB) 5600MHz,450

SSD,256GB NVMe M.2 SSD,29
SSD,512GB NVMe M.2 SSD,45
SSD,1TB NVMe M.2 SSD,75
SSD,2TB NVMe M.2 SSD,135
SSD,4TB NVMe M.2 SSD,280
SSD,8TB NVMe M.2 SSD,850
`;

        // Database Objects (Populated by CSV Parser)
        const cpuDatabase = {};
        const gpuDatabase = {};
        const ramDatabase = {};
        const ssdDatabase = {};

        // --- CSV PARSER ---
        function parseHardwareData() {
            const lines = HARDWARE_DATA_CSV.trim().split('\n');
            lines.forEach(line => {
                line = line.trim();
                if (!line || line.startsWith('Type')) return; // Skip empty or header

                const parts = line.split(',');
                if (parts.length >= 3) {
                    const type = parts[0].trim().toUpperCase();
                    const name = parts[1].trim();
                    const price = parseFloat(parts[2].trim());

                    if (type === 'CPU') cpuDatabase[name] = price;
                    else if (type === 'GPU') gpuDatabase[name] = price;
                    else if (type === 'RAM') ramDatabase[name] = price;
                    else if (type === 'SSD') ssdDatabase[name] = price;
                }
            });
        }

        // --- CONFIG ---
        const CORE_PARTS = [
            { id: 'cpu', label: 'CPU', icon: 'cpu', listId: 'cpu-options' },
            { id: 'motherboard', label: 'Motherboard', icon: 'circuitry' },
            { id: 'psu', label: 'Power Supply', icon: 'plug' },
            { id: 'cooler', label: 'Cooler', icon: 'snowflake' },
            { id: 'case', label: 'Case', icon: 'desktop-tower' },
            { id: 'os', label: 'OS', icon: 'windows-logo' }
        ];

        const OPTIONAL_PARTS = [
            { id: 'rgb', label: 'RGB Control', icon: 'lightbulb' },
            { id: 'wifi', label: 'WiFi Card', icon: 'wifi-high' }
        ];

        // --- STATE ---
        const STORAGE_PREFIX = 'pc_builder_dark_';
        const initialState = {
            singleParts: {
                cpu: { name: '', price: 0 },
                motherboard: { name: '', price: 0 },
                psu: { name: '', price: 0 },
                cooler: { name: '', price: 0 },
                case: { name: '', price: 0 },
                os: { name: '', price: 0 },
                rgb: { name: '', price: 0 },
                wifi: { name: '', price: 0 }
            },
            multiParts: {
                gpu: [{ name: '', price: 0 }],
                ram: [{ name: '', price: 0 }],
                ssd: [{ name: '', price: 0 }],
                fans: [],
                cables: [],
                other: []
            },
            profitMode: 'percent', // 'percent' or 'fixed'
            profitValue: 15        // Default 15%
        };

        let state = JSON.parse(JSON.stringify(initialState));

        // --- DOM GENERATION ---

        function initDatalists() {
            parseHardwareData();
            const fillList = (id, db) => {
                const list = document.getElementById(id);
                list.innerHTML = '';
                Object.keys(db).forEach(key => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    list.appendChild(opt);
                });
            };
            fillList('cpu-options', cpuDatabase);
            fillList('gpu-options', gpuDatabase);
            fillList('ram-options', ramDatabase);
            fillList('ssd-options', ssdDatabase);
        }

        function renderSingleInputs() {
            const coreContainer = document.getElementById('core-inputs-container');
            coreContainer.innerHTML = CORE_PARTS.map(part => createSingleInputHTML(part)).join('');
            const optionalContainer = document.getElementById('optional-inputs-container');
            optionalContainer.innerHTML = OPTIONAL_PARTS.map(part => createSingleInputHTML(part)).join('');
        }

        function createSingleInputHTML(part) {
            const listAttribute = part.listId ? `list="${part.listId}"` : '';
            return `
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-dark-input flex items-center justify-center text-slate-400 flex-shrink-0">
                        <i class="ph-fill ph-${part.icon}"></i>
                    </div>
                    <div class="flex-1 flex bg-dark-bg rounded-xl border border-dark-border focus-within:border-brand-500 focus-within:ring-1 focus-within:ring-brand-500 transition overflow-hidden">
                        <input type="text" 
                            placeholder="${part.label}" 
                            data-category="single" 
                            data-part="${part.id}" 
                            data-field="name" 
                            ${listAttribute}
                            class="w-full bg-transparent p-3 text-sm text-white placeholder-slate-600 outline-none"
                            oninput="handleInput(event)"
                            onchange="checkAutoFill(event)"
                        >
                        <div class="w-px bg-dark-border"></div>
                        <input type="number" 
                            inputmode="decimal" 
                            placeholder="0.00" 
                            data-category="single" 
                            data-part="${part.id}" 
                            data-field="price" 
                            class="w-1/3 bg-transparent p-3 text-sm text-right font-mono text-brand-500 placeholder-slate-700 outline-none"
                            oninput="handleInput(event)"
                        >
                        <div class="w-px bg-dark-border"></div>
                        <button onclick="openSearch(this)" class="px-3 bg-dark-input hover:bg-slate-600 text-slate-400 hover:text-white transition flex items-center justify-center" title="Search Online">
                            <i class="ph-bold ph-magnifying-glass"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function createMultiItemHTML(category, item, index) {
            let listAttribute = '';
            if (category === 'gpu') listAttribute = 'list="gpu-options"';
            else if (category === 'ram') listAttribute = 'list="ram-options"';
            else if (category === 'ssd') listAttribute = 'list="ssd-options"';
            
            return `
                <div class="flex gap-2 items-center multi-item animate-fade-in" data-category="${category}" data-index="${index}">
                    <div class="flex-1 flex bg-dark-bg rounded-xl border border-dark-border focus-within:border-brand-500 focus-within:ring-1 focus-within:ring-brand-500 transition overflow-hidden">
                        <input type="text" 
                            value="${item.name}" 
                            placeholder="Item Name" 
                            ${listAttribute}
                            class="w-full bg-transparent p-3 text-sm text-white placeholder-slate-600 outline-none"
                            oninput="handleMultiInput(this, 'name')"
                            onchange="handleMultiInput(this, 'name')" 
                        >
                        <div class="w-px bg-dark-border"></div>
                        <input type="number" 
                            inputmode="decimal" 
                            value="${item.price || ''}" 
                            placeholder="0.00" 
                            class="w-1/3 bg-transparent p-3 text-sm text-right font-mono text-brand-500 placeholder-slate-700 outline-none"
                            oninput="handleMultiInput(this, 'price')"
                        >
                        <div class="w-px bg-dark-border"></div>
                        <button onclick="openSearch(this)" class="px-3 bg-dark-input hover:bg-slate-600 text-slate-400 hover:text-white transition flex items-center justify-center" title="Search Online">
                            <i class="ph-bold ph-magnifying-glass"></i>
                        </button>
                    </div>
                    <button onclick="removeMultiItem('${category}', ${index})" class="w-10 h-10 rounded-xl bg-dark-input text-red-400 hover:text-red-300 hover:bg-red-900/20 flex items-center justify-center transition border border-transparent hover:border-red-900/30">
                        <i class="ph-bold ph-trash"></i>
                    </button>
                </div>
            `;
        }

        // --- SEARCH LOGIC ---
        function openSearch(btn) {
            const container = btn.closest('.flex-1');
            const input = container.querySelector('input[type="text"]');
            const query = input.value.trim();
            if (query) {
                const url = `https://www.google.com/search?tbm=shop&q=${encodeURIComponent(query)}`;
                window.open(url, '_blank');
            } else {
                alert("Please enter a part name first.");
            }
        }

        // --- AUTO-FILL LOGIC ---
        function checkAutoFill(e) {
            const input = e.target;
            const part = input.dataset.part;
            const val = input.value;
            if (part === 'cpu' && cpuDatabase[val]) {
                const price = cpuDatabase[val];
                const priceInput = input.parentElement.querySelector('input[type="number"]');
                if (priceInput) {
                    priceInput.value = price;
                    const event = new Event('input', { bubbles: true });
                    priceInput.dispatchEvent(event);
                }
            }
        }

        // --- PROFIT LOGIC ---
        function setProfitMode(mode) {
            state.profitMode = mode;
            updateProfitUI();
            calculate();
        }

        function updateProfitUI() {
            const btnPercent = document.getElementById('profit-mode-percent');
            const btnFixed = document.getElementById('profit-mode-fixed');
            
            // Reset styles
            const activeClass = "bg-brand-600 text-white shadow-sm";
            const inactiveClass = "text-slate-400 hover:text-white";
            
            btnPercent.className = `px-3 py-1 rounded-md text-xs font-bold transition ${state.profitMode === 'percent' ? activeClass : inactiveClass}`;
            btnFixed.className = `px-3 py-1 rounded-md text-xs font-bold transition ${state.profitMode === 'fixed' ? activeClass : inactiveClass}`;
        }

        function handleProfitInput(e) {
            state.profitValue = parseFloat(e.target.value) || 0;
            calculate();
        }

        // --- RENDER LOGIC ---
        function renderMultiList(category) {
            const container = document.getElementById(`${category}-list`);
            const list = state.multiParts[category];
            if (list.length === 0) {
                container.innerHTML = `<p class="text-[10px] text-slate-600 uppercase tracking-widest text-center py-1">Empty</p>`;
            } else {
                container.innerHTML = list.map((item, index) => createMultiItemHTML(category, item, index)).join('');
            }
        }

        function populateForm() {
            document.querySelectorAll('input[data-category="single"]').forEach(input => {
                const part = input.dataset.part;
                const field = input.dataset.field;
                if (state.singleParts[part]) {
                    input.value = state.singleParts[part][field] === 0 && field === 'price' ? '' : state.singleParts[part][field];
                }
            });
            Object.keys(state.multiParts).forEach(cat => renderMultiList(cat));
            
            // Profit
            document.getElementById('profit-input').value = state.profitValue;
            updateProfitUI();
            
            calculate();
        }

        // --- CALCULATION LOGIC ---
        function handleInput(e) {
            const target = e.target;
            const part = target.dataset.part;
            const field = target.dataset.field;
            let val = target.value;
            if (field === 'price') val = parseFloat(val) || 0;
            state.singleParts[part][field] = val;
            calculate();
        }

        function handleMultiInput(el, field) {
            const container = el.closest('.multi-item');
            const category = container.dataset.category;
            const index = parseInt(container.dataset.index);
            const val = el.value;
            
            if (field === 'price') {
                state.multiParts[category][index][field] = parseFloat(val) || 0;
            } else {
                state.multiParts[category][index][field] = val;
            }

            let autoPrice = 0;
            if (category === 'gpu' && gpuDatabase[val]) autoPrice = gpuDatabase[val];
            else if (category === 'ram' && ramDatabase[val]) autoPrice = ramDatabase[val];
            else if (category === 'ssd' && ssdDatabase[val]) autoPrice = ssdDatabase[val];

            if (autoPrice > 0 && field === 'name') {
                state.multiParts[category][index].price = autoPrice;
                const priceInput = container.querySelector('input[type="number"]');
                if (priceInput && priceInput.value != autoPrice) {
                    priceInput.value = autoPrice;
                }
            }
            calculate();
        }

        function addMultiItem(category) {
            state.multiParts[category].push({ name: '', price: 0 });
            renderMultiList(category);
            calculate();
        }

        function removeMultiItem(category, index) {
            state.multiParts[category].splice(index, 1);
            renderMultiList(category);
            calculate();
        }

        function calculate() {
            let subtotal = 0;
            Object.values(state.singleParts).forEach(p => subtotal += p.price);
            Object.values(state.multiParts).forEach(list => list.forEach(i => subtotal += i.price));

            let profit = 0;
            if (state.profitMode === 'percent') {
                profit = subtotal * (state.profitValue / 100);
            } else {
                profit = state.profitValue;
            }

            const total = subtotal + profit;
            const fmt = (n) => n.toLocaleString('en-US', { style: 'currency', currency: 'USD' });

            document.getElementById('bar-total').textContent = fmt(total);
            document.getElementById('modal-subtotal').textContent = fmt(subtotal);
            document.getElementById('modal-profit').textContent = `+${fmt(profit)}`;
            document.getElementById('modal-total').textContent = fmt(total);
        }

        // --- UI INTERACTION ---
        function toggleAccordion(id) {
            const content = document.getElementById(id);
            const btn = content.previousElementSibling;
            const isOpen = content.classList.contains('open');
            if (isOpen) {
                content.classList.remove('open');
                btn.setAttribute('aria-expanded', 'false');
            } else {
                content.classList.add('open');
                btn.setAttribute('aria-expanded', 'true');
            }
        }

        function openSummary() {
            const modal = document.getElementById('summary-modal');
            const backdrop = document.getElementById('modal-backdrop');
            const panel = document.getElementById('modal-panel');
            modal.classList.remove('hidden');
            setTimeout(() => {
                backdrop.classList.remove('opacity-0');
                panel.classList.remove('translate-y-full');
            }, 10);
            populateLoadSelect(); 
        }

        function closeSummary() {
            const modal = document.getElementById('summary-modal');
            const backdrop = document.getElementById('modal-backdrop');
            const panel = document.getElementById('modal-panel');
            backdrop.classList.add('opacity-0');
            panel.classList.add('translate-y-full');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // --- STORAGE ---
        function showMsg(txt, isErr) {
            const el = document.getElementById('save-msg');
            el.textContent = txt;
            el.className = `text-center text-xs h-4 ${isErr ? 'text-red-400' : 'text-emerald-400'}`;
            setTimeout(() => el.textContent = '', 3000);
        }

        function populateLoadSelect() {
            const sel = document.getElementById('saved-builds-select');
            sel.innerHTML = '<option value="">Load a saved build...</option>';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(STORAGE_PREFIX)) {
                    const name = key.replace(STORAGE_PREFIX, '');
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    sel.appendChild(opt);
                }
            }
        }

        function handleSave() {
            const name = document.getElementById('build-name').value.trim();
            if (!name) return showMsg('Please enter a name', true);
            try {
                localStorage.setItem(STORAGE_PREFIX + name, JSON.stringify(state));
                populateLoadSelect();
                showMsg('Build saved successfully!', false);
            } catch(e) {
                showMsg('Storage full!', true);
            }
        }

        function handleLoad() {
            const name = document.getElementById('saved-builds-select').value;
            const nameInput = document.getElementById('build-name');
            if (!name) return;
            const data = localStorage.getItem(STORAGE_PREFIX + name);
            if (data) {
                state = JSON.parse(data);
                // Ensure state structure compatibility
                state = { ...initialState, ...state };
                state.singleParts = { ...initialState.singleParts, ...state.singleParts };
                state.multiParts = { ...initialState.multiParts, ...state.multiParts };
                
                nameInput.value = name;
                populateForm();
                showMsg('Loaded!', false);
            }
        }

        function handleDelete() {
            const name = document.getElementById('build-name').value.trim();
            if (!name) return showMsg('Enter name to delete', true);
            if (localStorage.getItem(STORAGE_PREFIX + name)) {
                localStorage.removeItem(STORAGE_PREFIX + name);
                populateLoadSelect();
                document.getElementById('build-name').value = '';
                showMsg('Deleted', false);
            } else {
                showMsg('Not found', true);
            }
        }

        // --- INIT ---
        document.getElementById('reset-app-btn').addEventListener('click', () => {
            if(confirm('Clear all fields?')) {
                state = JSON.parse(JSON.stringify(initialState));
                populateForm();
            }
        });

        initDatalists();
        renderSingleInputs();
        populateForm();

    </script>
</body>
</html>
